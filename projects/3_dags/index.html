<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>dags | Janoś Gabler</title> <meta name="author" content="Janoś Gabler"/> <meta name="description" content="Tools to combine several interrelated Python functions into one."/> <meta name="keywords" content="Janos Gabler, Python, Economics, estimagic"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://janosg.github.io/projects/3_dags/"> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://janosg.github.io/"><span class="font-weight-bold">Janoś</span> Gabler</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">dags</h1> <p class="post-description">Tools to combine several interrelated Python functions into one.</p> </header> <article> <h2 id="what-is-dags">What is dags</h2> <p>dags provides tools to combine several interrelated functions into one function. The order in which the functions are called is determined by a topological sort on a Directed Acyclic Graph (DAG) that is constructed from the function signatures.</p> <p><img src="/assets/img/dags/logo_with_text.svg" class="rounded" width="480"></p> <h2 id="first-example">First example</h2> <p>Before talking about applications of dags, I will quickly show how it works on a toy example. Take for example, the following functions.</p> <p><img src="/assets/img/dags/functions.png" class="rounded" width="480"></p> <p>Now assume that we are actually interested in a combined function that calculates <code class="language-plaintext highlighter-rouge">h</code> given <code class="language-plaintext highlighter-rouge">x</code>, <code class="language-plaintext highlighter-rouge">y</code>, and <code class="language-plaintext highlighter-rouge">z</code>. We could write this function manually</p> <p><img src="/assets/img/dags/hardcoded_combined.png" class="rounded" width="480"></p> <p>But we can also create the function dynamically with dags</p> <p><img src="/assets/img/dags/dags_combined.png" class="rounded" width="480"></p> <p><code class="language-plaintext highlighter-rouge">hardcoded_combined</code> and <code class="language-plaintext highlighter-rouge">combined</code> behave exactly the same and both return 0.6 when called with arguments <code class="language-plaintext highlighter-rouge">x=1</code>, <code class="language-plaintext highlighter-rouge">y=2</code>, and <code class="language-plaintext highlighter-rouge">z=3</code>.</p> <p>You can find more examples in the <a href="https://dags.readthedocs.io/en/latest/examples.html" target="_blank" rel="noopener noreferrer">documentation</a>.</p> <h2 id="how-is-dags-useful">How is dags useful?</h2> <p>On a first glance, this looks just like a complicated way of achieving something simple. So when could this be useful? Let’s look at three different situations in which dags can be really helpful.</p> <h4 id="1-complicated-relationships-between-functions">1. Complicated relationships between functions</h4> <p>In the above example, it was easy to figure out that it does not matter if <code class="language-plaintext highlighter-rouge">f</code> or <code class="language-plaintext highlighter-rouge">g</code> is called first, but <code class="language-plaintext highlighter-rouge">h</code> can only be called in the end. But what if you have dozens or hundreds of functions and the dependencies are more complicated?</p> <p>A primary example of such a convoluted set of functions is the German tax and transfer system. If you don’t believe me, <a href="https://gettsim.readthedocs.io/en/stable/gettsim_objects/functions.html" target="_blank" rel="noopener noreferrer">convince yourself</a>.</p> <p><a href="https://gettsim.readthedocs.io/en/stable/index.html" target="_blank" rel="noopener noreferrer">The GErman Tax and Transfer SIMulator (GETTSIM)</a> is an effort by several German universities and the major economics research institutes to replace custom codes at each institute by a clean and well tested Python implementation.</p> <p>To achieve this, GETTSIM implements Python functions for all kinds of taxes and transfers and uses dags to figure out in which order these functions should be called.</p> <p>In fact, dags was created by <a href="https://github.com/tobiasraabe" target="_blank" rel="noopener noreferrer">Tobias Raabe</a> and me, while we worked on the architecture of GETTSIM.</p> <h4 id="2-need-to-exchange-parts-of-the-system">2. Need to exchange parts of the system</h4> <p>Another motivation for using dags over a hard-coded approach arises when it is necessary to easily switch out certain components of the system. To see how this situation arises in practice, let’s assume an economist wants to calculate the aggregate cost of replacing the current income tax by a simpler policy where everyone pays 25 % of their income. Keeping all other policies unchanged.</p> <p>Assume the old and new income tax functions look as follows</p> <p><img src="/assets/img/dags/tax_functions.png" class="rounded" width="480"></p> <p>Coding up the new function was simple enough, but to answer the research question we need to take into account all ramifications (e.g. changes in eligibility for different transfers due to changes in net income).</p> <p>If the function that calculates aggregate taxes and transfers was hard-coded, we would roughly have to do the following:</p> <ul> <li>Add a flag that decides whether the new or old policy is active</li> <li>Pass the flag through to the point where the income tax is calculated</li> <li>Use the flag to switch between calling the old and new function</li> </ul> <p>This is clearly not a desirable thing to do, especially if multiple researchers use the same code base to work on different questions.</p> <p>Dags provides a much better way. Assume that <code class="language-plaintext highlighter-rouge">old_functions</code> is a dictionary containing all functions of the current tax and transfer system. Then, implementing the policy becomes as simple as:</p> <p><img src="/assets/img/dags/new_income_tax.png" class="rounded" width="480"></p> <p>It is not even a problem that the new income tax has a different signature than the old one. It could depend on more or fewer arguments as long as all of them are calculated by some function in the functions dictionary.</p> <h4 id="3-different-combinations-of-functions-are-needed">3. Different combinations of functions are needed.</h4> <p>With dags it is easy to generate different combinations of a set of functions. Let’s first go back to the simple example to see how it is done:</p> <p><img src="/assets/img/dags/multi_target.png" class="rounded" width="480"></p> <p>By passing in a list of targets instead of just <code class="language-plaintext highlighter-rouge">"h"</code>, we told dags that the combined function also needs to return the intermediate variables. By specifying <code class="language-plaintext highlighter-rouge">return_type</code> dict, we said that we want them in a dictionary. Other possible return types are <code class="language-plaintext highlighter-rouge">"tuple"</code> or <code class="language-plaintext highlighter-rouge">"list"</code>.</p> <p>Again, a practical application can be found in GETTSIM, where we sometimes need all taxes, transfers, and intermediate variables and sometimes we focus on a single variable (e.g. child benefits).</p> <p>Not only can dags create a function that returns exactly what a user needs but it will also skip unnecessary computations. Only functions that are needed to create the targets will be called.</p> <h2 id="efficiency-of-dags-vs-hard-coding">Efficiency of dags vs hard-coding</h2> <p>Everything that is related to creating the dag and figuring out the order of execution is only done once, when the combined function is created and has no additional cost at runtime. Thus it can be seen as a compile time that is negligible if the combined function is called repeatedly.</p> <p>The runtime of the dynamically created function is approximately the same as in a hard-coding approach.</p> <h2 id="jax-compatibility">JAX compatibility</h2> <p>A very important feature of dags is that as long as the component functions are all <a href="https://jax.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">jax</a> compatible, the resulting function is also jax compatible. More precisely, dags created functions can be:</p> <ul> <li>Just in time compiled using <code class="language-plaintext highlighter-rouge">jax.jit</code> </li> <li>Vectorized, using <code class="language-plaintext highlighter-rouge">jax.vmap</code> </li> <li>Differentiated, using <code class="language-plaintext highlighter-rouge">jax.grad</code> and others.</li> </ul> <p>In extensive benchmarks, we could not find any speed difference between a hard-coded and dags approach when using <code class="language-plaintext highlighter-rouge">jax.jit</code> or <code class="language-plaintext highlighter-rouge">jax.vmap</code>!</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Janoś Gabler. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script src="/assets/js/zoom.js"></script> <script src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>